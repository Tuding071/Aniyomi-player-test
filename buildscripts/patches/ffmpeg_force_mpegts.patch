Subject: [PATCH] Add `force_mpegts` option
---
Index: libavformat/hls.c
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/libavformat/hls.c b/libavformat/hls.c
--- a/libavformat/hls.c	(revision b08d7969c550a804a59511c7b83f2dd8cc0499b8)
+++ b/libavformat/hls.c	(date 1758462450639)
@@ -224,6 +224,7 @@
     AVDictionary *seg_format_opts;
     char *allowed_extensions;
     int max_reload;
+    int force_mpegts;
     int http_persistent;
     int http_multiple;
     int http_seekable;
@@ -2108,6 +2109,8 @@
             // Keep this list in sync with ff_hls_senc_read_audio_setup_info()
             in_fmt = av_find_input_format(pls->audio_setup_info.codec_id == AV_CODEC_ID_AAC ? "aac" :
                                           pls->audio_setup_info.codec_id == AV_CODEC_ID_AC3 ? "ac3" : "eac3");
+        } else if (c->force_mpegts > 0) {
+            in_fmt = av_find_input_format("mpegts");
         } else {
             pls->ctx->probesize = s->probesize > 0 ? s->probesize : 1024 * 4;
             pls->ctx->max_analyze_duration = s->max_analyze_duration > 0 ? s->max_analyze_duration : 4 * AV_TIME_BASE;
@@ -2580,6 +2583,8 @@
         OFFSET(max_reload), AV_OPT_TYPE_INT, {.i64 = 3}, 0, INT_MAX, FLAGS},
     {"m3u8_hold_counters", "The maximum number of times to load m3u8 when it refreshes without new segments",
         OFFSET(m3u8_hold_counters), AV_OPT_TYPE_INT, {.i64 = 1000}, 0, INT_MAX, FLAGS},
+    {"force_mpegts", "Force use of mpegts format for hls segments",
+        OFFSET(force_mpegts), AV_OPT_TYPE_BOOL, {.i64 = 0}, 0, 1, FLAGS},
     {"http_persistent", "Use persistent HTTP connections",
         OFFSET(http_persistent), AV_OPT_TYPE_BOOL, {.i64 = 1}, 0, 1, FLAGS },
     {"http_multiple", "Use multiple HTTP connections for fetching segments",
